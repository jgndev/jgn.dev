# GitHub Webhook Setup Guide

This guide explains how to set up GitHub webhooks for jgn.dev so the site automatically refreshes content when new posts are added to your posts repository.

## Overview

When you push new `.md` files (blog posts) to your posts repository, GitHub will automatically notify your website, which will then refresh its content without requiring a restart.

## Prerequisites

1. Your website must be publicly accessible (not just `localhost`)
2. You need admin access to your posts repository on GitHub
3. You need access to set environment variables on your server

## Step 1: Generate a Webhook Secret

First, generate a secure secret that GitHub will use to sign webhook requests:

```bash
openssl rand -hex 32
```

Save this secret - you'll need it in both your server environment and GitHub webhook configuration.

## Step 2: Configure Your Server

Set the webhook secret as an environment variable on your server:

```bash
export GITHUB_WEBHOOK_SECRET=your_generated_secret_here
```

For production deployments, add this to your deployment configuration:

### GCP Cloud Run
```bash
# Set via gcloud CLI
gcloud run services update jgn-dev \
    --set-env-vars GITHUB_WEBHOOK_SECRET=your_generated_secret_here \
    --region=us-central1

# Or configure in Terraform (terraform/terraform.tfvars)
github_webhook_secret = "your_generated_secret_here"
```

### GitHub Actions CI/CD
Add the secret to your GitHub repository secrets:
1. Go to **Settings** â†’ **Secrets and variables** â†’ **Actions**
2. Add new secret: `GITHUB_WEBHOOK_SECRET`
3. Value: Your generated secret

## Step 3: Configure GitHub Webhook

1. Go to your posts repository on GitHub
2. Navigate to **Settings** â†’ **Webhooks**
3. Click **Add webhook**
4. Fill in the webhook details:
   - **Payload URL**: 
     - For Cloud Run: `https://jgn-dev-xxxxx-xx.a.run.app/webhook/github`
     - For custom domain: `https://jgn.dev/webhook/github`
   - **Content type**: `application/json`
   - **Secret**: The secret you generated in Step 1
   - **Events**: Select "Just the push event"
   - **Active**: âœ… Checked

5. Click **Add webhook**  

ðŸ’¡ **Cloud Run Note**: Your webhook URL will be similar to `https://jgn-dev-xxxxx-xx.a.run.app/webhook/github` where `xxxxx-xx` is generated by Google. You can find the exact URL in the GCP Console or via `gcloud run services describe jgn-dev --region=us-central1 --format="value(status.url)"`.

ðŸ’¡ If your site is not deployed yet, you will get a message `Last delivery was not successful. Failed to connect to host.` This is expected behavior until your deployment is completed and the URL resolves.

## Step 4: Test the Webhook

1. Make sure your website is running with the webhook secret configured
2. Add or modify a `.md` file in your posts repository
3. Commit and push the changes to the main branch
4. Check your server logs - you should see messages like:
   ```
   Detected markdown file change: new-post.md
   Refreshing content due to webhook from username/posts-repo
   Successfully refreshed content from webhook
   ```

### Viewing Logs on Cloud Run

```bash
# View recent logs
gcloud logs read --filter="resource.type=cloud_run_revision AND resource.labels.service_name=jgn-dev" --limit=50

# Follow logs in real-time
gcloud logs tail --filter="resource.type=cloud_run_revision AND resource.labels.service_name=jgn-dev"
```

## How It Works

1. **GitHub Push**: When you push changes to your posts repo
2. **Webhook Trigger**: GitHub sends a POST request to `/webhook/github`
3. **Signature Verification**: Your server verifies the request came from GitHub
4. **Change Detection**: Server checks if any `.md` files were added/modified
5. **Content Refresh**: If markdown files changed, server calls `ContentManager.RefreshContent()`
6. **Live Update**: New posts are immediately available to readers

## Security Features

- **Signature Verification**: Uses HMAC-SHA256 to verify requests came from GitHub
- **Branch Filtering**: Only responds to pushes to main/master branch
- **File Type Filtering**: Only triggers refresh when markdown files are changed
- **Environment Isolation**: Webhook secret is stored as environment variable
- **HTTPS Only**: All webhook traffic is encrypted in transit

## Troubleshooting

### Webhook Not Triggering

1. **Check your server logs** for error messages:
   ```bash
   gcloud logs read --filter="resource.type=cloud_run_revision AND resource.labels.service_name=jgn-dev" --limit=20
   ```

2. **Verify the webhook secret** matches between GitHub and your server
3. **Ensure your webhook URL is publicly accessible** - test with:
   ```bash
   curl -I https://your-cloud-run-url.a.run.app/webhook/github
   ```
4. **Check GitHub's webhook delivery logs** in the repo settings

### Content Not Refreshing

1. **Verify the push was to the main/master branch**
2. **Confirm `.md` files were actually added/modified** in the commit
3. **Check server logs** for `RefreshContent()` errors
4. **Ensure your `GITHUB_TOKEN` is still valid**:
   ```bash
   curl -H "Authorization: token YOUR_GITHUB_TOKEN" https://api.github.com/user
   ```

### Rate Limiting

- The webhook system respects your existing GitHub API rate limits
- With a `GITHUB_TOKEN`, you have 5,000 requests/hour
- Without authentication, you're limited to 60 requests/hour

### GitHub Webhook Delivery Issues

1. **Check webhook delivery logs** in GitHub:
   - Go to your posts repository
   - Settings â†’ Webhooks â†’ Your webhook
   - Click on recent deliveries to see response codes

2. **Common response codes**:
   - `200`: Success
   - `404`: Webhook endpoint not found
   - `500`: Server error (check Cloud Run logs)
   - `Timeout`: Request took too long (increase Cloud Run timeout)

## Production Considerations

- **Use HTTPS** for your webhook endpoint (Cloud Run provides this automatically)
- **Monitor webhook delivery success rates** in GitHub webhook settings
- **Set up Cloud Run monitoring** for webhook endpoint performance
- **Consider rate limiting** the webhook endpoint to prevent abuse
- **Configure alerting** for failed content refreshes

### Cloud Run Specific Considerations

- **Cold starts**: First webhook after period of inactivity may be slower
- **Timeouts**: Default request timeout is 5 minutes
- **Concurrency**: Multiple webhooks can be processed concurrently
- **Scaling**: Service will auto-scale based on webhook volume

## Testing Locally

For local development, you can use tools like [ngrok](https://ngrok.com/) to expose your local server:

```bash
# Install ngrok
brew install ngrok  # macOS
# or download from https://ngrok.com/

# In one terminal, start your local server
./scripts/run-dev.sh

# In another terminal, expose it
ngrok http 8080

# Use the ngrok URL as your webhook endpoint
# Example: https://abc123.ngrok.io/webhook/github
```

This allows you to test webhook functionality during development.

## Advanced Configuration

### Multiple Repositories

If you have multiple content repositories, you can configure webhooks for each:

```go
// The webhook handler automatically detects which repository sent the webhook
// and can handle content from multiple sources
```

### Custom Webhook Endpoints

You can create custom webhook endpoints for different content types:

```bash
# Different endpoints for different content types
https://jgn.dev/webhook/github     # Main posts
https://jgn.dev/webhook/docs       # Documentation updates
https://jgn.dev/webhook/assets     # Asset updates
```

### Webhook Retries

GitHub will retry failed webhook deliveries:
- Immediate retry on failure
- Additional retries with exponential backoff
- Up to 3 retry attempts over 8 hours

## Monitoring Webhook Health

### Cloud Run Metrics

Monitor webhook performance in GCP Console:
1. Go to **Cloud Run** â†’ **jgn-dev**
2. View **Metrics** tab
3. Monitor:
   - Request count
   - Request latency
   - Error rate
   - Container utilization

### GitHub Webhook Analytics

Track webhook delivery in GitHub:
1. Repository **Settings** â†’ **Webhooks**
2. Click on your webhook
3. View delivery history and success rates

---

**Need help?** Open an issue in the [GitHub repository](https://github.com/jgndev/jgn.dev/issues) or check the troubleshooting section above. 